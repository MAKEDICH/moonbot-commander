# High Load Configuration
# Конфигурация для высоких нагрузок (3000+ серверов)
# ОПТИМИЗИРОВАНО ДЛЯ 3000+ СЕРВЕРОВ

# ============================================================
# DATABASE SETTINGS (PostgreSQL рекомендуется)
# ============================================================
database:
  # ОБЯЗАТЕЛЬНО для 3000+ серверов:
  # Установите DATABASE_URL=postgresql+asyncpg://user:pass@host:5432/moonbot
  # Или DATABASE_URL=postgresql://user:pass@host:5432/moonbot
  
  # Connection Pool Settings (оптимизировано для 3000+ серверов)
  pool:
    # Размер пула соединений (увеличен для высокой нагрузки)
    pool_size: 100
    # Максимальное количество соединений сверх pool_size
    max_overflow: 200
    # Таймаут получения соединения из пула (секунды)
    pool_timeout: 30
    # Время жизни соединения (секунды)
    pool_recycle: 1800
    # Проверка соединения перед использованием
    pool_pre_ping: true
  
  # Query optimization
  query:
    # Включить логирование медленных запросов
    slow_query_log: true
    # Порог медленного запроса (секунды)
    slow_query_threshold: 0.5

# ============================================================
# UDP PROCESSING (оптимизировано для 3000+ серверов)
# ============================================================
udp:
  # Глобальный сокет
  global_socket:
    # Размер буфера приёма (bytes) - увеличен для 3000+ серверов
    recv_buffer_size: 8388608  # 8MB
    # Размер буфера отправки (bytes)
    send_buffer_size: 4194304  # 4MB
  
  # Пул обработчиков сообщений (УВЕЛИЧЕН ДЛЯ 3000+ СЕРВЕРОВ)
  # Работает во ВСЕХ режимах (local, server, dev, production)
  worker_pool:
    # Включить Worker Pool (рекомендуется true для любой нагрузки)
    enabled: true
    # Количество воркеров для обработки сообщений
    # 32 воркера для 3000+ серверов
    workers: 32
    # Размер очереди сообщений (увеличен для burst нагрузки)
    queue_size: 50000
    # Таймаут ожидания в очереди (секунды)
    queue_timeout: 10.0
  
  # Batch processing
  batch:
    # Включить пакетную обработку
    enabled: true
    # Максимальный размер пакета (увеличен)
    max_batch_size: 200
    # Максимальное время ожидания пакета (мс)
    max_batch_wait_ms: 50

# ============================================================
# WEBSOCKET SETTINGS
# ============================================================
websocket:
  # Батчинг сообщений
  batch:
    enabled: true
    # Максимальный размер пакета сообщений
    max_size: 50
    # Интервал отправки пакетов (мс)
    interval_ms: 100
  
  # Сжатие
  compression:
    enabled: true
    # Минимальный размер сообщения для сжатия (bytes)
    min_size: 1024
  
  # Лимиты
  limits:
    # Максимум соединений на пользователя
    max_connections_per_user: 10
    # Максимум сообщений в секунду на соединение
    max_messages_per_second: 100

# ============================================================
# CACHING (REDIS) - ОБЯЗАТЕЛЬНО для 3000+ серверов
# ============================================================
redis:
  # ОБЯЗАТЕЛЬНО установить Redis для 3000+ серверов
  # URL подключения к Redis
  url_env: "REDIS_URL"
  default_url: "redis://localhost:6379/0"
  
  # Connection pool (увеличен для 3000+ серверов)
  pool:
    max_connections: 200
    timeout: 10
    retry_on_timeout: true
  
  # Настройки кэша
  cache:
    # TTL по умолчанию (секунды)
    default_ttl: 300
    # TTL для балансов (секунды) - короткий для актуальности
    balance_ttl: 5
    # TTL для стратегий (секунды)
    strategies_ttl: 30
    # TTL для статусов серверов (секунды)
    server_status_ttl: 10

# ============================================================
# RATE LIMITING
# ============================================================
rate_limiting:
  # Глобальный лимит запросов в минуту
  global_per_minute: 10000
  # Лимит на пользователя в минуту
  per_user_per_minute: 1000
  # Лимит на IP в минуту
  per_ip_per_minute: 500
  
  # Burst limits
  burst:
    # Разрешённый burst
    max_burst: 100
    # Период восстановления (секунды)
    recovery_period: 10

# ============================================================
# ASYNC PROCESSING (оптимизировано для 3000+ серверов)
# ============================================================
async_processing:
  # Очередь задач
  task_queue:
    # Максимальный размер очереди (увеличен)
    max_size: 100000
    # Количество воркеров (увеличен)
    workers: 16
  
  # Bulk operations (оптимизировано для 3000+ серверов)
  bulk:
    # Размер пакета для bulk insert (увеличен)
    insert_batch_size: 1000
    # Интервал flush (мс) - уменьшен для быстрой записи
    flush_interval_ms: 50

# ============================================================
# MONITORING
# ============================================================
monitoring:
  # Prometheus metrics
  prometheus:
    enabled: true
    port: 9090
  
  # Health checks
  health:
    # Интервал проверки (секунды)
    check_interval: 30
    # Таймаут проверки (секунды)
    timeout: 10
  
  # Логирование метрик
  metrics_logging:
    enabled: true
    interval_seconds: 60

# ============================================================
# UVICORN/GUNICORN SETTINGS (оптимизировано для 3000+ серверов)
# ============================================================
uvicorn:
  # Количество воркеров Gunicorn (2 * CPU cores + 1, минимум 17 для 3000+ серверов)
  workers: 17
  # Максимум соединений на воркер (увеличен)
  limit_concurrency: 2000
  # Backlog (очередь ожидающих соединений) - увеличен
  backlog: 4096
  # Таймаут keep-alive (секунды)
  timeout_keep_alive: 30
  # Таймаут graceful shutdown (секунды)
  graceful_timeout: 60

# ============================================================
# SYSTEM LIMITS (рекомендации для 3000+ серверов)
# ============================================================
system:
  # Рекомендуемые лимиты для Linux:
  # ulimit -n 65535  # Максимум открытых файлов
  # sysctl -w net.core.somaxconn=4096  # Backlog
  # sysctl -w net.core.rmem_max=8388608  # Буфер приёма
  # sysctl -w net.core.wmem_max=4194304  # Буфер отправки
  recommended_file_limit: 65535
  recommended_somaxconn: 4096

